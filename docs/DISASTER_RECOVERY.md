# 재해 복구 계획 (Disaster Recovery Plan)

> **최종 업데이트**: 2025. 01. 27  
> **목표**: RTO 4시간, RPO 1시간

---

## 📋 개요

이 문서는 강원특별자치도 보조기기센터 시스템의 재해 복구 계획을 정의합니다.

### 목표 지표

- **RTO (Recovery Time Objective)**: 4시간
  - 시스템 장애 발생 후 정상 운영 복구까지의 목표 시간
- **RPO (Recovery Point Objective)**: 1시간
  - 데이터 손실 허용 범위 (최대 1시간 전 데이터까지 복구 가능)

---

## 🔄 백업 전략

### 다중 백업 정책

#### 1. 일일 백업 (Daily Backup)
- **실행 시간**: 매일 오전 2시 (UTC)
- **보관 기간**: 30일
- **대상**: 모든 주요 테이블 (profiles, clients, applications, inventory, rentals, schedules, notices 등)
- **자동화**: Vercel Cron Jobs 또는 Supabase Functions

#### 2. 주간 백업 (Weekly Backup)
- **실행 시간**: 매주 일요일 오전 2시 (UTC)
- **보관 기간**: 90일 (3개월)
- **대상**: 전체 데이터베이스 스냅샷
- **용도**: 주간 단위 복구 및 장기 보관

#### 3. 월간 백업 (Monthly Backup)
- **실행 시간**: 매월 1일 오전 2시 (UTC)
- **보관 기간**: 365일 (1년)
- **대상**: 전체 데이터베이스 + 스키마 + 설정
- **용도**: 장기 보관 및 규정 준수

#### 4. 수동 백업 (Manual Backup)
- **실행**: 필요 시 관리자가 수동 실행
- **보관 기간**: 180일
- **용도**: 주요 변경 사항 전/후, 배포 전 등

---

## 📦 백업 저장소

### 저장 위치

1. **Supabase Storage** (1차 저장소)
   - 경로: `backups/{type}/{backup_name}.json`
   - 접근: 관리자 권한 필요

2. **외부 저장소** (2차 저장소, 향후 구현)
   - AWS S3, Google Cloud Storage 등
   - 지리적 분산 보관

### 백업 파일 형식

- **형식**: JSON (압축 가능)
- **구조**: 테이블별 데이터 분리
- **메타데이터**: 백업 일시, 테이블 수, 레코드 수, 파일 크기 등

---

## 🧪 복구 테스트

### 분기별 복구 테스트

매 분기마다 다음 절차로 복구 테스트를 수행합니다:

1. **테스트 환경 준비**
   - 별도 테스트 데이터베이스 생성
   - 최신 백업 파일 다운로드

2. **복구 실행**
   - 백업 파일을 테스트 환경에 복원
   - 데이터 무결성 검증

3. **검증 항목**
   - ✅ 모든 테이블 데이터 복원 확인
   - ✅ 외래 키 관계 정상 작동 확인
   - ✅ 인덱스 및 제약조건 정상 확인
   - ✅ 애플리케이션 기능 테스트

4. **결과 기록**
   - `backup_logs` 테이블에 복구 테스트 결과 기록
   - 문제 발견 시 즉시 조치

### 복구 테스트 실행

```bash
# 최신 백업으로 복구 테스트
pnpm tsx scripts/restore-test.ts latest

# 특정 백업으로 복구 테스트
pnpm tsx scripts/restore-test.ts <backup_id>
```

---

## 🚨 재해 복구 절차

### 1단계: 상황 파악 (15분)

1. 장애 원인 확인
2. 영향 범위 평가
3. 백업 상태 확인

### 2단계: 백업 선택 (15분)

1. 최신 백업 파일 확인
2. RPO 목표에 맞는 백업 선택 (최대 1시간 전)
3. 복구 전략 수립

### 3단계: 데이터 복구 (2시간)

1. 테스트 환경에서 복구 검증
2. 프로덕션 환경 복구 실행
3. 데이터 무결성 검증

### 4단계: 시스템 복구 (1시간)

1. 애플리케이션 재시작
2. 기능 테스트
3. 모니터링 확인

### 5단계: 검증 및 완료 (30분)

1. 전체 시스템 기능 테스트
2. 사용자 확인
3. 사후 보고서 작성

**총 소요 시간**: 약 4시간 (RTO 목표 달성)

---

## 📊 백업 모니터링

### 백업 상태 확인

#### API 엔드포인트

```bash
# 백업 상태 조회
GET /api/backup/status

# 특정 타입 백업 조회
GET /api/backup/status?type=daily&limit=10
```

#### 백업 실행

```bash
# 수동 백업 실행
POST /api/backup?type=manual
```

### 백업 로그 테이블

`backup_logs` 테이블에서 다음 정보를 확인할 수 있습니다:

- 백업 타입 및 상태
- 백업 파일 크기 및 레코드 수
- 저장 위치 및 만료일
- 복구 테스트 결과

---

## 🔧 백업 스크립트 사용법

### 일일 백업 실행

```bash
pnpm tsx scripts/backup.ts daily
```

### 주간 백업 실행

```bash
pnpm tsx scripts/backup.ts weekly
```

### 월간 백업 실행

```bash
pnpm tsx scripts/backup.ts monthly
```

### 수동 백업 실행

```bash
pnpm tsx scripts/backup.ts manual
```

---

## ⚠️ 주의사항

1. **프로덕션 데이터 보호**
   - 복구 테스트는 반드시 테스트 환경에서만 실행
   - `RESTORE_TEST_MODE=true` 환경 변수 설정 필수

2. **백업 파일 보안**
   - 백업 파일에는 민감한 개인정보가 포함될 수 있음
   - 접근 권한 엄격히 관리
   - 암호화 저장 권장

3. **정기 점검**
   - 백업 로그 정기 확인
   - 만료된 백업 파일 자동 삭제
   - 저장소 용량 모니터링

---

## 📝 체크리스트

### 일일 확인
- [ ] 자동 백업 실행 확인
- [ ] 백업 상태 모니터링

### 주간 확인
- [ ] 주간 백업 완료 확인
- [ ] 백업 파일 무결성 검증

### 월간 확인
- [ ] 월간 백업 완료 확인
- [ ] 저장소 용량 확인

### 분기별 확인
- [ ] 복구 테스트 실행
- [ ] 재해 복구 절차 검토
- [ ] 백업 정책 업데이트

---

## 🔗 관련 문서

- [SaaS 안정화 체크리스트](./TODO.md#saas-안정화-최우선)
- [데이터베이스 스키마 분석](./DB_SCHEMA_ANALYSIS.md)
- [보안 가이드](./SECURITY_GUIDE.md)

---

**문의**: 시스템 관리자에게 문의하세요.
